#= require highcharts/highstock
#= require jquery3
#= require jquery/jquery-ui.min

bdsa_severity_color = (score, severity) ->
  if score > 7
    if severity.toLowerCase() == 'high' then '#9c251f' else '#5a100c'
  else if score > 4
    'rgb(255, 165, 160)'
  else
    '#D3D3D3'

bdsa_cvss = (cvss_data, severity) ->
  [
    {
      y: cvss_data[0]
      name: 'Overall(Temporal)'
      color: bdsa_severity_color(cvss_data[0], severity)
    }
    {
      y: cvss_data[1]
      name: 'Base'
      color: bdsa_severity_color(cvss_data[1], severity)
    }
    {
      y: cvss_data[2]
      name: 'Exploitability'
      color: bdsa_severity_color(cvss_data[2], severity)
    }
    {
      y: cvss_data[3]
      name: 'Impact'
      color: bdsa_severity_color(cvss_data[3], severity)
    }
  ]

search_bdsa = (id) ->
  if id != ''
    window.location.href = '/vulnerabilities/bdsa/' + id

$(document).ready ->
  $('.bdsa-vulnerability input').keypress (e) ->
    if e.keyCode == 13
      search_bdsa $(this).val()
  $('.bdsa-vulnerability button').click () ->
    search_bdsa $('.bdsa-vulnerability input').val()
  if $('.bdsa-vulnerability .details').length > 0
    setDefaultChartOptions()
    Highcharts.chart 'cvss2',
      title: text: 'CVSS v2'
      series: [ { data: bdsa_cvss($('#cvss2').data('cvss'), $('#cvss2').data('severity')) } ]
    Highcharts.chart 'cvss3',
      title: text: 'CVSS v3'
      series: [ { data: bdsa_cvss($('#cvss3').data('cvss'), $('#cvss3').data('severity')) } ]

setDefaultChartOptions = ->
  Highcharts.setOptions
    tooltip: enabled: false
    chart: type: 'column'
    exporting: enabled: false
    credits: enabled: false
    xAxis: categories: [
      'Overall (Temporal)'
      'Base'
      'Exploitability'
      'Impact'
    ]
    yAxis:
      min: 0
      max: 10
      title: text: null
    legend: enabled: false
    plotOptions:
      series: enableMouseTracking: false
      column:
        pointPadding: 0.3
        borderWidth: 0
        dataLabels:
          enabled: true
          crop: false
