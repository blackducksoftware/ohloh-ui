#= require jquery3
#= require jquery/jquery-ui.min
#= require js.cookie

bdsa_severity_color = (score, severity) ->
  if score > 7
    if severity.toLowerCase() == 'high' then 'rgb(156,37,31)' else 'rgb(90,16,12)'
  else if score > 4
    'rgb(231,140,135)'
  else
    'rgb(154,155,156)'

bdsa_cvss3 = (cvss_data, severity) ->
  [
    {
      y: cvss_data[0]
      name: 'Overall (Base and Temporal)'
      color: bdsa_severity_color(cvss_data[0], severity)
    }
    {
      y: cvss_data[1]
      name: 'Base'
      color: bdsa_severity_color(cvss_data[1], severity)
    }
    {
      y: cvss_data[2]
      name: 'Exploitability'
      color: bdsa_severity_color(cvss_data[2], severity)
    }
    {
      y: cvss_data[3]
      name: 'Impact'
      color: bdsa_severity_color(cvss_data[3], severity)
    }
  ]

cve_cvss3 = (cvss_data, severity) ->
  [
    {
      y: cvss_data[1]
      name: 'Overall (Base)'
      color: bdsa_severity_color(cvss_data[1], severity)
    }
    {
      y: cvss_data[2]
      name: 'Exploitability'
      color: bdsa_severity_color(cvss_data[2], severity)
    }
    {
      y: cvss_data[3]
      name: 'Impact'
      color: bdsa_severity_color(cvss_data[3], severity)
    }
  ]

search_bdsa = (id) ->
  if id != ''
    id = id.toUpperCase()
    bdsa_format = /^BDSA-(19|[2-9][0-9])\d{2}-\d{4}$/
    if bdsa_format.test(id)
      window.location.href = '/vulnerabilities/bdsa/' + id
    else
      alert('Please enter a valid BDSA seach text -> BDSA-yyyy-nnnn.')

$(document).ready ->
  BdsaCookieConsent.init()
  $('.bdsa-vulnerability input').keypress (e) ->
    if e.keyCode == 13
      search_bdsa $(this).val()
  $('.bdsa-vulnerability button.bdsa-search').click () ->
    search_bdsa $('.bdsa-vulnerability input').val()
  if $('.bdsa-vulnerability .details').length > 0
    setDefaultChartOptions()
    Highcharts.chart 'cvss3',
      title: text: undefined
      xAxis: categories: ['Overall (Base and Temporal)', 'Base', 'Exploitability', 'Impact']
      series: [ { data: bdsa_cvss3($('#cvss3').data('cvss'), $('#cvss3').data('severity')) } ]
    Highcharts.chart 'cve-cvss3',
      title: text: undefined
      xAxis: categories: ['Overall (Base)', 'Exploitability', 'Impact']
      series: [ { data: cve_cvss3($('#cve-cvss3').data('cvss'), $('#cve-cvss3').data('severity')) } ]

setDefaultChartOptions = ->
  Highcharts.setOptions
    tooltip: enabled: false
    chart:
      type: 'column'
      backgroundColor: 'rgba(0,0,0,0)'
    exporting: enabled: false
    credits: enabled: false
    yAxis:
      min: 0
      max: 10
      title: text: null
      labels: style: fontSize: 11, color: '#666666'
    xAxis:
      labels: style: fontSize: 11, color: '#666666'
    legend: enabled: false
    plotOptions:
      series:
        enableMouseTracking: false
        dataLabels:
          style: fontSize: 11, color: '#000000'
      column:
        pointPadding: 0.3
        borderWidth: 0
        dataLabels:
          enabled: true
          crop: false
BdsaCookieConsent =
  init: () ->
    bdsaCookiesAllowed = Cookies.get('bdsa_cookie_disclaimer')
    if bdsaCookiesAllowed
      bdsaVisitedCount = parseInt(bdsaCookiesAllowed)
      if bdsaVisitedCount < 35
        Cookies.set 'bdsa_cookie_disclaimer', bdsaVisitedCount + 1
      else
        cookieStore.delete('bdsa_cookie_disclaimer')
        $('#bdsa_disclaimer_cookies').show()
    $('.bdsa_disclaimer_accept').on 'click', (e) ->
      BdsaCookieConsent.set() unless bdsaCookiesAllowed
    $('#bdsa_disclaimer_check').on 'change', ->
      if $('#bdsa_disclaimer_check').is(':checked')
        $('.bdsa_disclaimer_accept').removeAttr 'disabled'
      else
        $('.bdsa_disclaimer_accept').attr 'disabled', 'disabled'

  set: () ->
    Cookies.set 'bdsa_cookie_disclaimer', 0
    location.reload()
