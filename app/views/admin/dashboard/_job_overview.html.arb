# frozen_string_literal: true

panel 'Job Overview' do
  columns do
    column do
      panel "Show Results For: #{human_window}" do
        windows = %i[ten_minutes one_hour two_hours eight_hours one_day two_days one_week one_month all]
        windows.each do |w|
          a w.to_s.humanize.titleize, href: admin_root_path(window: w)
        end
      end
    end

    column do
      panel 'Key' do
        status_tag 'Scheduled', class: 'scheduled'
        status_tag 'Running < 5 minutes', class: 'under-five-minute'
        status_tag 'Running < 1 hour', class: 'under-one-hour'
        status_tag 'Running > 1 hour', class: 'more-than-one-hour'
        status_tag 'Failed', class: 'failed'
      end
    end
  end

  table_for Worker.includes(:running_jobs, :failed_jobs).order(:id), row_class: ->(elem) { 'deny' if elem.deny? } do
    # Seriously.  ActiveAdmin thinks the singular of "worker" is "slafe"  wft?
    column :hostname do |worker|
      link_to worker.hostname, admin_slafe_path(worker)
    end
    column :allow_deny do |allow_deny|
      status_tag('Allow', :ok) if allow_deny.allow?
      status_tag('Deny', :error) if allow_deny.deny?
    end
    column :load_average
    column :jobs do |worker|
      render partial: 'worker', locals: { worker: worker }
    end
    column :failed do |worker|
      render partial: 'failed', locals: { worker: worker }
    end
    column :completed do |worker|
      worker.jobs.complete.since(get_window).count
    end
  end
end
