# frozen_string_literal: true

class ProjectVulnerabilityReport < ActiveRecord::Base
  belongs_to :project
  default_scope { select('*, DENSE_RANK() OVER (ORDER BY vulnerability_score) as rank') }

  def self.max_rank
    sql = <<-SQL
      SELECT MAX(rank) as max_rank FROM (
        SELECT DENSE_RANK() OVER (ORDER BY vulnerability_score) as rank from project_vulnerability_reports
      ) project_vulnerability_reports
    SQL
    find_by_sql(sql).first.max_rank
  end

  def self.max_score
    maximum(:vulnerability_score).to_f
  end

  def current_rank
    sql = <<-SQL
      SELECT rank FROM (
        SELECT project_id, DENSE_RANK() OVER (ORDER BY vulnerability_score) as rank
        from project_vulnerability_reports
      ) temp where project_id = #{project_id}
    SQL
    collection = self.class.find_by_sql(sql)
    collection.first.rank
  end
end
