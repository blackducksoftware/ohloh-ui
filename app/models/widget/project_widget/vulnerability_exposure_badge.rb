class ProjectWidget::VulnerabilityExposureBadge < ProjectWidget
  def short_nice_name
    I18n.t('project_widgets.vulnerability_exposure_badge.short_nice_name')
  end

  def width
    245
  end

  def height
    50
  end

  def image
    pvr = project.project_vulnerability_report
    image_data = [{ text: project.name.truncate(18).shellescape, align: :center }]
    image_data += [score_text(pvr), percentage_text(pvr), rank_text(pvr)] if pvr
    image_data += [{ text: I18n.t('project_widgets.vulnerability_exposure_badge.text'), align: :center }]
    WidgetBadge::Partner.create(image_data)
  end

  def position
    25
  end

  private

  def score_text(pvr)
    score = pvr.vulnerability_score.to_f.round(2)
    text = I18n.t('project_widgets.vulnerability_exposure_badge.score_text', value: score)
    { text: text, align: :center }
  end

  def rank_text(pvr)
    rank = pvr.current_rank.ordinalize
    max_rank = ProjectVulnerabilityReport.max_rank
    text = I18n.t('project_widgets.vulnerability_exposure_badge.rank_text', value: rank, max_rank: max_rank)
    { text: text, align: :center }
  end

  def percentage_text(pvr)
    score = pvr.vulnerability_score.to_f.round(2)
    percentage_number = ((score / ProjectVulnerabilityReport.max_score) * 100)
    percentage = ApplicationController.helpers.number_to_percentage(percentage_number, precision: 2)
    text = I18n.t('project_widgets.vulnerability_exposure_badge.percentage_text', value: percentage)
    { text: text, align: :center }
  end
end
